<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Taints and Affinity :: Kubernetes Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/kubernetes-tutorial/taints-affinity.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/kubernetes-tutorial">Kubernetes Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="kubernetes-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">1. Requirements</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="installation.html">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="installation.html#tutorial-all-local">CLI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="installation.html#install-minikube">Install Minikube</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="installation.html#start-kubernetes">Start Kubernetes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">2. Beginner</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kubectl.html">kubectl</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pod-rs-deployment.html">Pod, ReplicaSet, Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="service.html">Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="logs.html">Logs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="service-magic.html">Service Magic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="blue-green.html">Blue/Green Deployments</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">3. Elementary</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="building-images.html">Building Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resources.html">Resources and Limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="rolling-updates.html">Rolling updates</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="live-ready.html">Liveness, Readiness &amp; Startup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configmap.html">ConfigMap</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Intermediate</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="secrets.html">Secrets</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crds.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="volumes-persistentvolumes.html">Volumes</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="taints-affinity.html">Taints &amp; Affinity</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="jobs-cronjobs.html">Jobs &amp; CronJobs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="daemonset.html">DaemonSet</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="statefulset.html">StatefulSet</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">5. Advanced</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ingress.html">Ingress</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">kubernetes-tutorial</a></li>
    <li>4. Intermediate</li>
    <li><a href="taints-affinity.html">Taints &amp; Affinity</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/kameshsampath/kubernetes-tutorial/edit/master/documentation/modules/ROOT/pages/taints-affinity.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Taints and Affinity</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>So far, when we deployed any Pod in the Kubernetes cluster, it was run on any node that met the requirements (ie memory requirements, CPU requirements, &#8230;&#8203;)</p>
</div>
<div class="paragraph">
<p>However, in Kubernetes there are two concepts that allow you to further configure the scheduler, so that Pods are assigned to Nodes following some business criteria.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preparation"><a class="anchor" href="#_preparation"></a>Preparation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are running this tutorial in Minikube, you need to add more nodes to run this part of the tutorial.
Check the number of nodes you have delpoyed by running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get nodes</code></pre>
</div>
</div>
<div class="paragraph">
<p>If only one node is present then you need to create a new node by following the next steps:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME       STATUS   ROLES    AGE     VERSION
kube       Ready    master   54m     v1.17.3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Having <code>minikube</code> installed and in your <code>PATH</code>, then run:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minikube node add -p devnation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or if you do not have enough resources to add a new node with same resources as master node, you can create a new cluster with minial requirements.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minikube start --nodes 2 -p multinode --kubernetes-version='v1.18.6' --vm-driver='virtualbox' --memory=2048</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get nodes</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME       STATUS   ROLES    AGE     VERSION
kube       Ready    master   54m     v1.17.3
kube-m02   Ready    &lt;none&gt;   2m50s   v1.17.3</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Multi-node clusters are currently experimental and might exhibit unintended behavior.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_taints_and_tolerations"><a class="anchor" href="#_taints_and_tolerations"></a>Taints and Tolerations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Taint is applied to a Kubernetes Node that signals the scheduler to avoid or not schedule certain Pods.</p>
</div>
<div class="paragraph">
<p>A Toleration is applied to a Pod definition and provides an exception to the taint.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s describe the current nodes, in this case as an OpenShift cluster is used, you can see several nodes:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl describe nodes | egrep "Name:|Taints:"</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:               ip-10-0-136-107.eu-central-1.compute.internal
Taints:             node-role.kubernetes.io/master:NoSchedule
Name:               ip-10-0-140-186.eu-central-1.compute.internal
Taints:             &lt;none&gt;
Name:               ip-10-0-141-128.eu-central-1.compute.internal
Taints:             &lt;none&gt;
Name:               ip-10-0-146-109.eu-central-1.compute.internal
Taints:             &lt;none&gt;
Name:               ip-10-0-150-226.eu-central-1.compute.internal
Taints:             &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that in this case, the <code>master</code> node contains a taint which blocks your application Pods from being scheduled there.</p>
</div>
<div class="sect2">
<h3 id="_taints"><a class="anchor" href="#_taints"></a>Taints</h3>
<div class="paragraph">
<p>Let&#8217;s add a taint to all nodes:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl taint nodes --all=true color=blue:NoSchedule</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">node/ip-10-0-136-107.eu-central-1.compute.internal tainted
node/ip-10-0-140-186.eu-central-1.compute.internal tainted
node/ip-10-0-141-128.eu-central-1.compute.internal tainted
node/ip-10-0-146-109.eu-central-1.compute.internal tainted
node/ip-10-0-150-226.eu-central-1.compute.internal tainted
node/ip-10-0-155-122.eu-central-1.compute.internal tainted
node/ip-10-0-162-206.eu-central-1.compute.internal tainted
node/ip-10-0-168-102.eu-central-1.compute.internal tainted
node/ip-10-0-175-64.eu-central-1.compute.internal tainted</code></pre>
</div>
</div>
<div class="paragraph">
<p>The color=blue is simply a key=value pair to identify the taint and NoSchedule is the specific effect.</p>
</div>
<div class="paragraph">
<p>Now deploy a new pod.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-deployment.yml

kubectl get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>The pod will remain in Pending status as it has no schedulable Node available.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                     READY   STATUS    RESTARTS   AGE
myboot-7f889dd6d-n5z55   0/1     Pending   0          55s</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl describe pod myboot-7f889dd6d-n5z55</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:           myboot-7f889dd6d-n5z55
Namespace:      kubetut
Priority:       0
Node:           &lt;none&gt;
Labels:         app=myboot
                pod-template-hash=7f889dd6d
Annotations:    openshift.io/scc: restricted
Status:         Pending

Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason            Age        From               Message
  ----     ------            ----       ----               -------
  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/9 nodes are available: 9 node(s) had taints that the pod didn't tolerate.
  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/9 nodes are available: 9 node(s) had taints that the pod didn't tolerate.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s remove one taint from one node and see what&#8217;s happening:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get nodes</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                            STATUS   ROLES    AGE   VERSION
ip-10-0-136-107.eu-central-1.compute.internal   Ready    master   20h   v1.16.2
ip-10-0-140-186.eu-central-1.compute.internal   Ready    worker   20h   v1.16.2
ip-10-0-141-128.eu-central-1.compute.internal   Ready    worker   18h   v1.16.2
ip-10-0-146-109.eu-central-1.compute.internal   Ready    worker   18h   v1.16.2
ip-10-0-150-226.eu-central-1.compute.internal   Ready    worker   20h   v1.16.2
ip-10-0-155-122.eu-central-1.compute.internal   Ready    master   20h   v1.16.2
ip-10-0-162-206.eu-central-1.compute.internal   Ready    worker   20h   v1.16.2
ip-10-0-168-102.eu-central-1.compute.internal   Ready    master   20h   v1.16.2
ip-10-0-175-64.eu-central-1.compute.internal    Ready    worker   18h   v1.16.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pick one node.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl taint node ip-10-0-140-186.eu-central-1.compute.internal color:NoSchedule-</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">node/ip-10-0-140-186.eu-central-1.compute.internal  untainted</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl describe nodes | egrep "Name:|Taints:"</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:               ip-10-0-136-107.eu-central-1.compute.internal
Taints:             node-role.kubernetes.io/master:NoSchedule
Name:               ip-10-0-140-186.eu-central-1.compute.internal
Taints:             &lt;none&gt;
Name:               ip-10-0-141-128.eu-central-1.compute.internal
Taints:             color=blue:NoSchedule
Name:               ip-10-0-146-109.eu-central-1.compute.internal
Taints:             color=blue:NoSchedule</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you should see the Pending pod scheduled to the newly untained node.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                     READY   STATUS    RESTARTS   AGE
myboot-7f889dd6d-n5z55   1/1     Running   0          11m</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can use <code>kubectl get pods -o wide</code> to see the node upon which the pod is scheduled.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_clean_up"><a class="anchor" href="#_clean_up"></a>Clean Up</h4>
<div class="paragraph">
<p>Undeploy the myboot deployment and add again the taint to the node:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f apps/kubefiles/myboot-deployment.yml

kubectl taint node ip-10-0-140-186.eu-central-1.compute.internal color=blue:NoSchedule</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tolerations"><a class="anchor" href="#_tolerations"></a>Tolerations</h3>
<div class="paragraph">
<p>Let&#8217;s create a Pod but containing a toleration, so it can be scheduled to a tainted node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  tolerations:
  - key: "color"
    operator: "Equal"
    value: "blue"
    effect: "NoSchedule"
  containers:
  - name: myboot
    image: quay.io/rhdevelopers/myboot:v1</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-toleration.yaml

kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                      READY   STATUS    RESTARTS   AGE
myboot-84b457458b-mbf9r   1/1     Running   0          3m18s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, although all nodes contain a taint, the Pod is scheduled and run as we defined a tolerance against color=blue taint.</p>
</div>
<div class="sect3">
<h4 id="_clean_up_2"><a class="anchor" href="#_clean_up_2"></a>Clean Up</h4>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f apps/kubefiles/myboot-toleration.yaml</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_noexecution_taint"><a class="anchor" href="#_noexecution_taint"></a>NoExecution Taint</h3>
<div class="paragraph">
<p>So far, you&#8217;ve seen the <code>NoSchedule</code> taint effect which means that newly created Pods will not be scheduled there unless they have an overriding toleration.
But notice that if we add this taint to a node that already has running/scheduled Pods, this taint will not terminate them.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s change that by using <code>NoExecution</code> effect.</p>
</div>
<div class="paragraph">
<p>First of all, let&#8217;s remove all previous taints.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl taint nodes --all=true color=blue:NoSchedule-</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then deploy a service:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-deployment.yml

kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                     READY   STATUS    RESTARTS   AGE
myboot-7f889dd6d-bkfg5   1/1     Running   0          16s</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pod myboot-7f889dd6d-bkfg5 -o json | jq '.spec.nodeName'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">"ip-10-0-146-109.eu-central-1.compute.internal"</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl taint node ip-10-0-146-109.eu-central-1.compute.internal color=blue:NoExecute

kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                     READY   STATUS        RESTARTS   AGE
myboot-7f889dd6d-8fm2v   1/1     Running       0          14s
myboot-7f889dd6d-bkfg5   1/1     Terminating   0          5m51s</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have more nodes available then the Pod is terminated and deployed onto another node, if it is not the case, then the Pod will remain in <em>Pending</em> status.</p>
</div>
<div class="paragraph">
<p>You can watch this "rescheduling" occur with use of  <code>-o wide</code></p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl get pods -o wide</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                     READY   STATUS        RESTARTS   AGE     IP           NODE
myboot-7f889dd6d-b9tks   1/1     Running       0          6s      10.88.0.5    devnation-m02
myboot-7f889dd6d-l897f   1/1     Terminating   0          9m11s   172.17.0.4   devnation</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_clean_up_3"><a class="anchor" href="#_clean_up_3"></a>Clean Up</h4>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f apps/kubefiles/myboot-deployment.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>And remove the NoExecute taint</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl taint node ip-10-0-146-109.eu-central-1.compute.internal color=blue:NoExecute-</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_affinity_anti_affinity"><a class="anchor" href="#_affinity_anti_affinity"></a>Affinity &amp; Anti-Affinity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is another way of changing where Pods are scheduled using Node/Pod Affinity and Anti-affinity.
You can create rules that not only ban where Pods can run but also to favor where they should be run.</p>
</div>
<div class="paragraph">
<p>In addition to creating affinities between Pods and Nodes, you can also create affinities between Pods.  You can decide that a group of Pods should be always be deployed together on the same node(s).
Reasons such as significant network communication between Pods and you want to avoid external network calls or perhaps shared storage devices.</p>
</div>
<div class="sect2">
<h3 id="_node_affinity"><a class="anchor" href="#_node_affinity"></a>Node Affinity</h3>
<div class="paragraph">
<p>Let&#8217;s deploy a new pod with a node affinity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: color
            operator: In
            values:
            - blue
      containers:
      - name: myboot
        image: quay.io/rhdevelopers/myboot:v1</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-node-affinity.yml

kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                           READY   STATUS    RESTARTS   AGE
myboot-54d788fdc8-f6wks        0/1     Pending   0          13s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a label on a node matching the affinity expression:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get nodes</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                            STATUS   ROLES    AGE   VERSION
ip-10-0-136-107.eu-central-1.compute.internal   Ready    master   26h   v1.16.2
ip-10-0-140-186.eu-central-1.compute.internal   Ready    worker   26h   v1.16.2
ip-10-0-141-128.eu-central-1.compute.internal   Ready    worker   25h   v1.16.2
ip-10-0-146-109.eu-central-1.compute.internal   Ready    worker   25h   v1.16.2
ip-10-0-150-226.eu-central-1.compute.internal   Ready    worker   26h   v1.16.2
ip-10-0-155-122.eu-central-1.compute.internal   Ready    master   26h   v1.16.2
ip-10-0-162-206.eu-central-1.compute.internal   Ready    worker   26h   v1.16.2
ip-10-0-168-102.eu-central-1.compute.internal   Ready    master   26h   v1.16.2
ip-10-0-175-64.eu-central-1.compute.internal    Ready    worker   25h   v1.16.2</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl label nodes ip-10-0-175-64.eu-central-1.compute.internal color=blue</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">node/ip-10-0-175-64.eu-central-1.compute.internal labeled</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                          READY   STATUS    RESTARTS   AGE
myboot-54d788fdc8-f6wks       1/1     Running   0          7m57s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s delete the label from the node:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl label nodes ip-10-0-175-64.eu-central-1.compute.internal color-

kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                         READY   STATUS    RESTARTS   AGE
myboot-54d788fdc8-f6wks      1/1     Running   0          7m57s</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with taints, the rule is set during the scheduling phase, therefore, the Pod is not removed.</p>
</div>
<div class="paragraph">
<p>This is an example of a <em>hard</em> rule, if the Kubernetes scheduler does not find any node with the required label then the Pod reminds in <em>Pending</em> state.
There is also a way to create a <em>soft</em> rule, where the Kubernetes scheduler attempts to match the rules but if it can not then the Pod is scheduled to any node.  In the example below, you can see the use of the word <em>preferred</em> vs <em>required</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        preference:
          matchExpressions:
          - key: color
            operator: In
            values:
            - blue</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_clean_up_4"><a class="anchor" href="#_clean_up_4"></a>Clean Up</h4>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f apps/kubefiles/myboot-node-affinity.yml</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pod_affinityanti_affinity"><a class="anchor" href="#_pod_affinityanti_affinity"></a>Pod Affinity/Anti-Affinity</h3>
<div class="paragraph">
<p>Let&#8217;s deploy a new pod with a Pod Affinity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  affinity:
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - topologyKey: kubernetes.io/hostname <i class="conum" data-value="1"></i><b>(1)</b>
        labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - myboot <i class="conum" data-value="2"></i><b>(2)</b>
  containers:</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The node label key. If two nodes are labeled with this key and have identical values, the scheduler treats both nodes as being in the same topology. In this case, <code>hostname</code> is a label that is different for each node.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The affinity is with Pods labeled with <code>app=myboot</code>.</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-pod-affinity.yml

kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                                              READY   STATUS    RESTARTS   AGE
myboot2-784bc58c8d-j2l74                                          0/1     Pending   0          19s</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>myboot2</code> Pod is pending as couldn&#8217;t find any Pod matching the affinity rule.
Let&#8217;s deploy <code>myboot</code> application labeled with <code>app=myboot</code>.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-deployment.yml

kubectl get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                                              READY   STATUS    RESTARTS   AGE
myboot-7f889dd6d-tr7gr                                            1/1     Running   0          3m27s
myboot2-64566b697b-snm7p                                          1/1     Running   0          18s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now both applications are running in the same node:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pod myboot-7f889dd6d-tr7gr -o json | jq '.spec.nodeName'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">"ip-10-0-146-109.eu-central-1.compute.internal"</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pod myboot2-64566b697b-snm7p -o json | jq '.spec.nodeName'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">"ip-10-0-146-109.eu-central-1.compute.internal"</code></pre>
</div>
</div>
<div class="paragraph">
<p>What you&#8217;ve seen here is a <em>hard</em> rule, you can use a "soft" rules as well in Pod Affinity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        podAffinityTerm:
          topologyKey: kubernetes.io/hostname
          labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - myboot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Anti-affinity is used to insure that two Pods do NOT run together on the same node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - topologyKey: kubernetes.io/hostname
        labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - myboot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deploy a myboot3 with an anti-affinity rule</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f apps/kubefiles/myboot-pod-antiaffinity.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then use the <code>kubectl get pods -o wide</code> command to see which pods land on which nodes.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods -o wide</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                       READY   STATUS    RESTARTS   AGE    IP          NODE
myboot-7f889dd6d-tr7gz     1/1     Running   0          4m27s  10.88.0.9   devnation-m02
myboot2-64566b697b-snm7p   1/1     Running   0          48s    10.88.0.10  devnation-m02
myboot3-78656b637r-suy1t   1/1     Running   0          1s     172.17.0.2  devnation</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>myboot3</code> Pod is deployed in a different node than the <code>myboot</code> Pod</p>
</div>
<div class="sect3">
<h4 id="_clean_up_5"><a class="anchor" href="#_clean_up_5"></a>Clean Up</h4>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -f apps/kubefiles/myboot-pod-affinity.yml
kubectl delete -f apps/kubefiles/myboot-pod-antiaffinity.yml
kubectl delete -f apps/kubefiles/myboot-deployment.yml</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
